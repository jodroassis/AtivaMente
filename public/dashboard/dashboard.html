<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="shortcut icon"
      href="../assets/icon/favicon2.ico"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AtivaMente | Dashboards</title>

    <link rel="stylesheet" href="./../css/teste.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script
      src="https://kit.fontawesome.com/9f7414eb10.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <!-- <body onload=" atualizarFeed()"> -->

  <body>
    <div class="janela">
      <div class="header-left">
        <h1>AtivaMente</h1>

        <div class="hello">
          <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
          <span id="mostrar_cpf"></span>
        </div>

        <div class="btn-nav-white">
          <a href="./home.html">
            <h3>Início</h3>
          </a>
        </div>

        <div class="btn-nav-white">
          <a href="./pesquisa.html">
            <h3>Pesquisa</h3>
          </a>
        </div>

        <div class="btn-nav">
          <h3>Gráficos</h3>
        </div>

        <div class="btn-logout" onclick="limparSessao()">
          <h3>Sair</h3>
        </div>
      </div>

      <div class="dash" onload="carregarDados()">
        <h1>Dashboard de Saúde</h1>

        <!-- Indicadores-Chave -->
        <div class="kpis">
          <div class="kpi-card">
            <h3>Idade Média</h3>
            <p id="idade-media">--</p>
          </div>
          <div class="kpi-card">
            <h3>Atividades Físicas Regulares</h3>
            <p id="atividade-fisica">--%</p>
          </div>
          <div class="kpi-card">
            <h3>Saúde Mental boa</h3>
            <p id="saude-mental">--%</p>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="pizza">
          <div class="chart-container">
            <h2>Atividade Física</h2>
            <canvas id="graficoAtividadeFisica"></canvas>
          </div>

          <div class="chart-container">
            <h2>Qualidade da Alimentação</h2>
            <canvas id="graficoAlimentacao"></canvas>
          </div>
        </div>

        <div class="dispersao">
          <div class="chart-container">
            <h2>Sono x Saúde Mental</h2>
            <canvas id="graficoSonoSaudeMental"></canvas>
          </div>

          <!-- Gráficos de Correlacionamento -->
          <div class="chart-container">
            <h2>Horas de Sono e Nível de Estresse</h2>
            <canvas id="graficoSonoxEstresse"></canvas>
          </div>
        </div>

        <div>
          <h3>Visualização de Objetivos de Saúde</h3>
          <canvas id="graficoObjetivosSaude"></canvas>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  mostrar_cpf.innerHTML = sessionStorage.CPF_USUARIO;

  // Função chamada no carregamento da página
  window.onload = function () {
    carregarDados();
  };
  // Função para carregar os dados e preencher os indicadores e gráficos
  function carregarDados() {
    // Requisição para calcular a idade média
    fetch("/pesquisa/calcularIdadeMedia")
      .then((response) => response.json())
      .then((data) => {
        if (data && data[0] && typeof data[0].idadeMedia === "string") {
          var idadeMedia = parseFloat(data[0].idadeMedia).toFixed(1); // Converte para número e arredonda
          document.getElementById(
            "idade-media"
          ).textContent = `${idadeMedia} anos`;
        } else {
          console.error(
            "Erro ao carregar dados de idade média: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de idade média:", error)
      );

    // Requisição para calcular a frequência de atividade física
    fetch("/pesquisa/calcularFrequenciaAtividade")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados de Atividade Física:", data); // Verificar dados retornados
        if (data && Array.isArray(data)) {
          const atividadeFisica = data.map((item) => ({
            label: item.atividade_fisica,
            value: parseFloat(item.porcentagem) || 0, // Converte a porcentagem para número
          }));

          // Mostrar a porcentagem na KPI
          const atividadeFisicaTotal = atividadeFisica.reduce(
            (acc, item) => acc + item.value,
            0
          );
          const mediaAtividadeFisica = (
            atividadeFisicaTotal / atividadeFisica.length
          ).toFixed(1);
          document.getElementById(
            "atividade-fisica"
          ).textContent = `${mediaAtividadeFisica}%`;

          plotarGraficoPizza(
            atividadeFisica,
            "graficoAtividadeFisica",
            "Frequência de Atividade Física"
          );
        } else {
          console.error(
            "Erro ao carregar dados de atividade física: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de atividade física:", error)
      );

    // Requisição para calcular saúde mental
    fetch("/pesquisa/calcularSaudeMental")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados de Saúde Mental:", data);
        if (data && Array.isArray(data)) {
          // Inicializa o total de respostas como 0
          let totalRespostas = 0;

          // Faz o cálculo das porcentagens
          const excelente = data.find(
            (item) => item.saude_mental === "excelente"
          );
          const boa = data.find((item) => item.saude_mental === "boa");
          const regular = data.find((item) => item.saude_mental === "regular");

          // Converte as porcentagens para número e soma
          const excelentePorcentagem = excelente
            ? parseFloat(excelente.porcentagem)
            : 0;
          const boaPorcentagem = boa ? parseFloat(boa.porcentagem) : 0;
          const regularPorcentagem = regular
            ? parseFloat(regular.porcentagem)
            : 0;

          // Soma as porcentagens
          totalRespostas =
            excelentePorcentagem + boaPorcentagem + regularPorcentagem;

          // Verifique se o total é um número válido antes de chamar toFixed()
          if (!isNaN(totalRespostas)) {
            // Atualiza o KPI na interface
            document.getElementById(
              "saude-mental"
            ).textContent = `${totalRespostas.toFixed(2)}%`;
          } else {
            console.error(
              "Erro ao calcular total de saúde mental, valor inválido:",
              totalRespostas
            );
          }
        } else {
          console.error(
            "Erro ao carregar dados de saúde mental: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de saúde mental:", error)
      );

    // Requisição para atividade física
    fetch("/pesquisa/atividadeFisica")
      .then((response) => response.json())
      .then((data) => {
        // Cria um conjunto padrão de categorias
        const categorias = [
          { label: "Diariamente", value: 0 },
          { label: "Semanalmente", value: 0 },
          { label: "Ocasionalmente", value: 0 },
          { label: "Raramente", value: 0 },
          { label: "Nunca", value: 0 },
        ];

        // Mapeia os dados retornados para as categorias
        if (Array.isArray(data)) {
          data.forEach((item) => {
            const categoria = categorias.find(
              (cat) =>
                cat.label.toLowerCase() === item.atividade_fisica.toLowerCase()
            );
            if (categoria) {
              categoria.value = item.quantidade || 0;
            }
          });
        } else {
          console.error("Erro ao carregar dados de atividade física:", data);
          return;
        }

        // Plota o gráfico de pizza com os dados
        plotarGraficoPizza(
          categorias,
          "graficoAtividadeFisica",
          "Frequência de Atividade Física"
        );
      })
      .catch((error) =>
        console.error("Erro ao carregar dados de atividade física:", error)
      );

    // Requisição para alimentação
    fetch("/pesquisa/alimentacao")
      .then((response) => response.json())
      .then((data) => {
        // Cria um conjunto padrão de categorias
        const categorias = [
          { label: "saudavel", value: 0 },
          { label: "balanceada", value: 0 },
          { label: "desregrada", value: 0 },
          { label: "vegetariana", value: 0 },
        ];

        // Mapeia os dados retornados para as categorias
        if (Array.isArray(data)) {
          data.forEach((item) => {
            const categoria = categorias.find(
              (cat) =>
                cat.label.toLowerCase() === item.alimentacao.toLowerCase()
            );
            if (categoria) {
              categoria.value = item.quantidade || 0;
            }
          });
        } else {
          console.error("Erro ao carregar dados de alimentação:", data);
          return;
        }

        // Plota o gráfico de pizza com os dados
        plotarGraficoPizza(
          categorias,
          "graficoAlimentacao",
          "Qualidade da Alimentação"
        );
      })
      .catch((error) =>
        console.error("Erro ao carregar dados de alimentação:", error)
      );

    // Requisição para correlação entre sono e estresse
    fetch("/pesquisa/sonoxEstresse")
      .then((response) => response.json())
      .then((data) => {
        if (data && Array.isArray(data)) {
          const correlacaoSonoEstresse = data.map((item) => ({
            x: item.sono,
            y: item.nivel_estresse,
            quantidade: item.quantidade,
          }));

          plotarGraficoScatter(
            correlacaoSonoEstresse,
            "graficoSonoxEstresse",
            "Horas de Sono vs. Nível de Estresse"
          );
        } else {
          console.error(
            "Erro ao carregar dados de correlação sono-estresse:",
            data
          );
        }
      })
      .catch((error) =>
        console.error(
          "Erro ao carregar dados de correlação sono-estresse:",
          error
        )
      );

    // Requisição para saúde mental vs estresse
    fetch("/pesquisa/sonoSaudeMental")
      .then((response) => response.json())
      .then((data) => {
        console.log(data); // Verifique se os dados estão sendo carregados corretamente
        if (data && Array.isArray(data)) {
          const sonoSaudeMental = data.map((item) => ({
            saude_mental: item.saude_mental,
            sono: item.sono,
            quantidade: item.quantidade,
          }));

          // Chama a função para desenhar o gráfico de dispersão
          plotarGraficoDispersao(
            sonoSaudeMental,
            "graficoSonoSaudeMental", // ID do canvas
            "Sono x Saúde Mental" // Título do gráfico
          );
        } else {
          console.error("Erro ao carregar dados de sono x saúde mental:", data);
        }
      })
      .catch((error) => {
        console.error("Erro ao carregar dados de sono x saúde mental:", error);
      });

    // Requisição para objetivos de saúde
    fetch("/pesquisa/objetivoSaude")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados recebidos de objetivos de saúde:", data); // Verifique a resposta da API
        if (data && Array.isArray(data)) {
          const objetivosSaude = data.map((item) => ({
            label: item.objetivos_saude,
            value: item.quantidade,
          }));
          plotarGraficoBarras(
            objetivosSaude,
            "graficoObjetivosSaude", // ID do canvas
            "Objetivos de Saúde" // Título do gráfico
          );
        } else {
          console.error("Erro ao carregar dados de objetivos de saúde:", data);
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de objetivos de saúde:", error)
      );
  }

  // Função para destruir o gráfico anterior e criar um novo
  function destruirGrafico(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (canvas && canvas.chart) {
      canvas.chart.destroy();
    }
  }

  // Função para plotar gráfico de pizza
  function plotarGraficoPizza(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: data.map((item) => item.label),
        datasets: [
          {
            data: data.map((item) => item.value),
            backgroundColor: [
              "#ff6384",
              "#36a2eb",
              "#ffcd56",
              "#4bc0c0",
              "#9966ff",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.label}: ${tooltipItem.raw}`;
              },
            },
          },
          legend: { position: "top" },
        },
      },
    });
    canvas.chart = chart; // Salva a referência do gráfico no canvas
  }

  // Função para plotar gráfico de dispersão
  function plotarGraficoScatter(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }

    const ctx = canvas.getContext("2d");

    const chartData = {
      datasets: [
        {
          label: titulo,
          data: data,
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1,
          pointRadius: data.map((item) => item.quantidade * 5), // Tamanho dos pontos com base na quantidade
        },
      ],
    };

    const config = {
      type: "scatter",
      data: chartData,
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: "Horas de Sono",
            },
          },
          y: {
            type: "category", // Eixo categórico
            labels: ["Baixo", "Moderado", "Alto"], // Rótulos do eixo Y
            title: {
              display: true,
              text: "Nível de Estresse",
            },
          },
        },
      },
    };

    // Criando o gráfico
    new Chart(ctx, config);
  }

  // Função para plotar gráfico de barras
  function plotarGraficoBarra(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.map((item) => item.label),
        datasets: [
          {
            label: titulo,
            data: data.map((item) => item.value),
            backgroundColor: "#36a2eb",
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true },
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.label}: ${tooltipItem.raw}`;
              },
            },
          },
        },
      },
    });
    canvas.chart = chart; // Salva a referência do gráfico no canvas
  }

  function plotarGraficoBarras(dados, idCanvas, titulo) {
    const ctx = document.getElementById(idCanvas).getContext("2d");
    if (!ctx) {
      console.error(`Canvas com id ${idCanvas} não encontrado.`);
      return;
    }

    // Criar o gráfico de barras
    new Chart(ctx, {
      type: "bar", // Alterado para 'bar' para gráficos de barras
      data: {
        labels: dados.map((item) => item.label), // As opções dos objetivos de saúde
        datasets: [
          {
            label: titulo, // Título do gráfico
            data: dados.map((item) => item.value), // Valores para cada objetivo
            backgroundColor: "#36A2EB", // Cor das barras
            borderColor: "#2196F3", // Cor da borda das barras
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true, // Garantir que o eixo Y comece no zero
          },
        },
        plugins: {
          title: {
            display: true,
            text: titulo, // Mostrar título do gráfico
          },
          legend: {
            display: false, // Opcional: esconder a legenda
          },
        },
      },
    });
  }

  function plotarGraficoDispersao(data, canvasId, titulo) {
    const ctx = document.getElementById(canvasId).getContext("2d");

    const chartData = {
      datasets: [
        {
          label: titulo,
          data: data.map((item) => {
            let yValue;
            if (item.saude_mental === "excelente") {
              yValue = 1;
            } else if (item.saude_mental === "boa") {
              yValue = 2;
            } else if (item.saude_mental === "regular") {
              yValue = 3;
            } else {
              yValue = 4; // Para qualquer outro caso
            }
            return {
              x: item.sono,
              y: yValue, // Transformando a categoria em números
              r: item.quantidade * 5, // O tamanho do ponto depende da quantidade
            };
          }),
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1,
        },
      ],
    };

    const config = {
      type: "bubble", // Usando um gráfico de bolhas
      data: chartData,
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: "Horas de Sono",
            },
          },
          y: {
            title: {
              display: true,
              text: "Saúde Mental",
            },
            ticks: {
              callback: function (value) {
                if (value === 1) return "Excelente";
                if (value === 2) return "Boa";
                if (value === 3) return "Regular";
                return "Fraca";
              },
            },
          },
        },
      },
    };

    // Criando o gráfico
    new Chart(ctx, config);
  }
</script>

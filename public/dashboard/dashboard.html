<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Saúde</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .kpis {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .kpi-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        width: 30%;
        text-align: center;
        background-color: #f9f9f9;
      }
      .chart-container {
        margin-bottom: 40px;
      }
    </style>
  </head>
  <body onload="carregarDados()">
    <h1>Dashboard de Saúde</h1>

    <!-- Indicadores-Chave -->
    <div class="kpis">
      <div class="kpi-card">
        <h3>Idade Média</h3>
        <p id="idade-media">--</p>
      </div>
      <div class="kpi-card">
        <h3>Atividades Físicas Regulares</h3>
        <p id="atividade-fisica">--%</p>
      </div>
      <div class="kpi-card">
        <h3>Saúde Mental boa</h3>
        <p id="saude-mental">--%</p>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="chart-container">
      <h2>Atividade Física</h2>
      <canvas id="graficoAtividadeFisica"></canvas>
    </div>

    <div class="chart-container">
      <h2>Qualidade da Alimentação</h2>
      <canvas id="graficoAlimentacao"></canvas>
    </div>

    <div class="chart-container">
      <h2>Saúde Mental e Nível de Estresse</h2>
      <canvas id="graficoSaudeMentalxEstresse"></canvas>
    </div>

    <!-- Gráficos de Correlacionamento -->
    <div class="chart-container">
      <h2>Horas de Sono e Nível de Estresse</h2>
      <canvas id="graficoSonoxEstresse"></canvas>
    </div>

    <div>
      <h3>Visualização de Objetivos de Saúde</h3>
      <canvas id="graficoObjetivosSaude"></canvas>
    </div>
  </body>
</html>

<script>
  // Função chamada no carregamento da página
  window.onload = function () {
    carregarDados();
  };
  // Função para carregar os dados e preencher os indicadores e gráficos
  function carregarDados() {
    // Requisição para calcular a idade média
    fetch("/pesquisa/calcularIdadeMedia")
      .then((response) => response.json())
      .then((data) => {
        if (data && data[0] && typeof data[0].idadeMedia === "string") {
          const idadeMedia = parseFloat(data[0].idadeMedia).toFixed(1); // Converte para número e arredonda
          document.getElementById(
            "idade-media"
          ).textContent = `${idadeMedia} anos`;
        } else {
          console.error(
            "Erro ao carregar dados de idade média: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de idade média:", error)
      );

    // Requisição para calcular a frequência de atividade física
    fetch("/pesquisa/calcularFrequenciaAtividade")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados de Atividade Física:", data); // Verificar dados retornados
        if (data && Array.isArray(data)) {
          const atividadeFisica = data.map((item) => ({
            label: item.atividade_fisica,
            value: parseFloat(item.porcentagem) || 0, // Converte a porcentagem para número
          }));

          // Mostrar a porcentagem na KPI
          const atividadeFisicaTotal = atividadeFisica.reduce(
            (acc, item) => acc + item.value,
            0
          );
          const mediaAtividadeFisica = (
            atividadeFisicaTotal / atividadeFisica.length
          ).toFixed(1);
          document.getElementById(
            "atividade-fisica"
          ).textContent = `${mediaAtividadeFisica}%`;

          plotarGraficoPizza(
            atividadeFisica,
            "graficoAtividadeFisica",
            "Frequência de Atividade Física"
          );
        } else {
          console.error(
            "Erro ao carregar dados de atividade física: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de atividade física:", error)
      );

    // Requisição para calcular saúde mental
    fetch("/pesquisa/calcularSaudeMental")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados de Saúde Mental:", data);
        if (data && Array.isArray(data)) {
          // Inicializa o total de respostas como 0
          let totalRespostas = 0;

          // Faz o cálculo das porcentagens
          const excelente = data.find(
            (item) => item.saude_mental === "excelente"
          );
          const boa = data.find((item) => item.saude_mental === "boa");
          const regular = data.find((item) => item.saude_mental === "regular");

          // Converte as porcentagens para número e soma
          const excelentePorcentagem = excelente
            ? parseFloat(excelente.porcentagem)
            : 0;
          const boaPorcentagem = boa ? parseFloat(boa.porcentagem) : 0;
          const regularPorcentagem = regular
            ? parseFloat(regular.porcentagem)
            : 0;

          // Soma as porcentagens
          totalRespostas =
            excelentePorcentagem + boaPorcentagem + regularPorcentagem;

          // Verifique se o total é um número válido antes de chamar toFixed()
          if (!isNaN(totalRespostas)) {
            // Atualiza o KPI na interface
            document.getElementById(
              "saude-mental"
            ).textContent = `${totalRespostas.toFixed(2)}%`;
          } else {
            console.error(
              "Erro ao calcular total de saúde mental, valor inválido:",
              totalRespostas
            );
          }
        } else {
          console.error(
            "Erro ao carregar dados de saúde mental: dados inesperados",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de saúde mental:", error)
      );

    // Requisição para atividade física
    fetch("/pesquisa/atividadeFisica")
      .then((response) => response.json())
      .then((data) => {
        if (data && Array.isArray(data)) {
          const atividadeFisica = [
            { label: "Diariamente", value: data[0]?.quantidade || 0 },
            { label: "Semanalmente", value: data[1]?.quantidade || 0 },
            { label: "Ocasionalmente", value: data[2]?.quantidade || 0 },
            { label: "Raramente", value: data[3]?.quantidade || 0 },
            { label: "Nunca", value: data[4]?.quantidade || 0 },
          ];
          plotarGraficoPizza(
            atividadeFisica,
            "graficoAtividadeFisica",
            "Frequência de Atividade Física"
          );
        } else {
          console.error("Erro ao carregar dados de atividade física:", data);
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de atividade física:", error)
      );

    // Requisição para alimentação
    fetch("/pesquisa/alimentacao")
      .then((response) => response.json())
      .then((data) => {
        if (data && Array.isArray(data)) {
          const alimentacao = [
            { label: "Saudável", value: data[0]?.quantidade || 0 },
            { label: "Balanceada", value: data[1]?.quantidade || 0 },
            { label: "Desregrada", value: data[2]?.quantidade || 0 },
            { label: "Vegetariana", value: data[3]?.quantidade || 0 },
          ];
          plotarGraficoPizza(
            alimentacao,
            "graficoAlimentacao",
            "Qualidade da Alimentação"
          );
        } else {
          console.error("Erro ao carregar dados de alimentação:", data);
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de alimentação:", error)
      );

    // Requisição para correlação entre sono e estresse
    fetch("/pesquisa/sonoxEstresse")
      .then((response) => response.json())
      .then((data) => {
        if (data && Array.isArray(data)) {
          const correlacaoSonoEstresse = data.map((item) => ({
            x: item.sono,
            y:
              item.nivel_estresse === "baixo"
                ? 1
                : item.nivel_estresse === "alto"
                ? 2
                : 3,
          }));
          plotarGraficoScatter(
            correlacaoSonoEstresse,
            "graficoSonoxEstresse",
            "Horas de Sono vs. Nível de Estresse"
          );
        } else {
          console.error(
            "Erro ao carregar dados de correlação sono-estresse:",
            data
          );
        }
      })
      .catch((error) =>
        console.log(
          "Erro ao carregar dados de correlação sono-estresse:",
          error
        )
      );

    // Requisição para saúde mental vs estresse
    fetch("/pesquisa/saudeMentalxEstresse")
      .then((response) => response.json())
      .then((data) => {
        if (data && Array.isArray(data)) {
          // Organizando os dados para o gráfico de dispersão
          const saudeMentalEstresse = data.map((item) => ({
            saude_mental: item.saude_mental, // Como saúde mental é uma categoria
            nivel_estresse: item.nivel_estresse, // O nível de estresse (baixo, alto, etc.)
            quantidade: item.quantidade, // Quantidade de ocorrências
          }));

          // Chama a função para desenhar o gráfico de dispersão
          plotarGraficoDispersao(
            saudeMentalEstresse,
            "graficoSaudeMentalxEstresse", // ID do canvas
            "Saúde Mental x Estresse" // Título do gráfico
          );
        } else {
          console.error(
            "Erro ao carregar dados de saúde mental x estresse:",
            data
          );
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de saúde mental x estresse:", error)
      );

    // Requisição para objetivos de saúde
    fetch("/pesquisa/objetivoSaude")
      .then((response) => response.json())
      .then((data) => {
        console.log("Dados recebidos de objetivos de saúde:", data); // Verifique a resposta da API
        if (data && Array.isArray(data)) {
          const objetivosSaude = data.map((item) => ({
            label: item.objetivos_saude,
            value: item.quantidade,
          }));
          plotarGraficoBarras(
            objetivosSaude,
            "graficoObjetivosSaude", // ID do canvas
            "Objetivos de Saúde" // Título do gráfico
          );
        } else {
          console.error("Erro ao carregar dados de objetivos de saúde:", data);
        }
      })
      .catch((error) =>
        console.log("Erro ao carregar dados de objetivos de saúde:", error)
      );
  }

  // Função para destruir o gráfico anterior e criar um novo
  function destruirGrafico(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (canvas && canvas.chart) {
      canvas.chart.destroy();
    }
  }

  // Função para plotar gráfico de pizza
  function plotarGraficoPizza(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: data.map((item) => item.label),
        datasets: [
          {
            data: data.map((item) => item.value),
            backgroundColor: [
              "#ff6384",
              "#36a2eb",
              "#ffcd56",
              "#4bc0c0",
              "#9966ff",
            ],
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.label}: ${tooltipItem.raw}`;
              },
            },
          },
          legend: { position: "top" },
        },
      },
    });
    canvas.chart = chart; // Salva a referência do gráfico no canvas
  }

  // Função para plotar gráfico de dispersão
  function plotarGraficoScatter(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [
          {
            label: titulo,
            data: data,
            backgroundColor: "#ff6384",
            borderColor: "#ff6384",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: { type: "linear", position: "bottom" },
          y: { beginAtZero: true },
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `X: ${tooltipItem.raw.x}, Y: ${tooltipItem.raw.y}`;
              },
            },
          },
        },
      },
    });
    canvas.chart = chart; // Salva a referência do gráfico no canvas
  }

  // Função para plotar gráfico de barras
  function plotarGraficoBarra(data, canvasId, titulo) {
    destruirGrafico(canvasId); // Destrói o gráfico anterior, se existir
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas com id ${canvasId} não encontrado.`);
      return;
    }
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.map((item) => item.label),
        datasets: [
          {
            label: titulo,
            data: data.map((item) => item.value),
            backgroundColor: "#36a2eb",
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true },
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.label}: ${tooltipItem.raw}`;
              },
            },
          },
        },
      },
    });
    canvas.chart = chart; // Salva a referência do gráfico no canvas
  }

  function plotarGraficoBarras(dados, idCanvas, titulo) {
    const ctx = document.getElementById(idCanvas).getContext("2d");
    if (!ctx) {
      console.error(`Canvas com id ${idCanvas} não encontrado.`);
      return;
    }

    // Criar o gráfico de barras
    new Chart(ctx, {
      type: "bar", // Alterado para 'bar' para gráficos de barras
      data: {
        labels: dados.map((item) => item.label), // As opções dos objetivos de saúde
        datasets: [
          {
            label: titulo, // Título do gráfico
            data: dados.map((item) => item.value), // Valores para cada objetivo
            backgroundColor: "#36A2EB", // Cor das barras
            borderColor: "#2196F3", // Cor da borda das barras
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true, // Garantir que o eixo Y comece no zero
          },
        },
        plugins: {
          title: {
            display: true,
            text: titulo, // Mostrar título do gráfico
          },
          legend: {
            display: false, // Opcional: esconder a legenda
          },
        },
      },
    });
  }

  function plotarGraficoDispersao(dados, idCanvas, titulo) {
    const ctx = document.getElementById(idCanvas).getContext("2d");
    if (!ctx) {
      console.error(`Canvas com id ${idCanvas} não encontrado.`);
      return;
    }

    // Normalizando os valores de saúde mental e estresse
    const niveisSaudeMental = {
      excelente: 4,
      boa: 3,
      regular: 2,
      fraca: 1,
    };

    const niveisEstresse = {
      baixo: 1,
      alto: 2,
      "muito alto": 3,
    };

    // Organize os dados para o gráfico de dispersão
    const pontos = dados.map((item) => ({
      x: niveisSaudeMental[item.saude_mental] || 0, // Converte a saúde mental para valor numérico
      y: niveisEstresse[item.nivel_estresse] || 0, // Converte o nível de estresse para valor numérico
      r: item.quantidade * 10, // Tamanho do ponto, baseado na quantidade
    }));

    // Criar o gráfico de dispersão
    new Chart(ctx, {
      type: "bubble", // Tipo do gráfico (dispersão)
      data: {
        datasets: [
          {
            label: titulo,
            data: pontos, // Dados organizados
            backgroundColor: "rgba(54, 162, 235, 0.6)", // Cor dos pontos
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "linear", // Escala linear para o eixo X
            min: 0,
            max: 4, // Limites para os níveis de saúde mental
            ticks: {
              stepSize: 1,
              callback: function (value) {
                const labels = ["Fraca", "Regular", "Boa", "Excelente"];
                return labels[value] || "";
              },
            },
          },
          y: {
            type: "linear", // Escala linear para o eixo Y
            min: 0,
            max: 3, // Limites para os níveis de estresse
            ticks: {
              stepSize: 1,
              callback: function (value) {
                const labels = ["Baixo", "Alto", "Muito Alto"];
                return labels[value] || "";
              },
            },
          },
        },
        plugins: {
          title: {
            display: true,
            text: titulo, // Título do gráfico
          },
          legend: {
            display: false, // Esconder a legenda (se necessário)
          },
        },
      },
    });
  }
</script>

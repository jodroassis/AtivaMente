<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="shortcut icon"
      href="../assets/icon/favicon2.ico"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AtivaMente | Dashboards</title>

    <link rel="stylesheet" href="./../css/teste.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script
      src="https://kit.fontawesome.com/9f7414eb10.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <body onload="obterresponse()">
    <div class="janela">
      <div class="header-left">
        <h1>AtivaMente</h1>

        <div class="hello">
          <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
          <span id="mostrar_cpf"></span>
        </div>

        <div class="btn-nav-white">
          <a href="./home.html">
            <h3>Início</h3>
          </a>
        </div>

        <div class="btn-nav-white">
          <a href="./pesquisa.html">
            <h3>Pesquisa</h3>
          </a>
        </div>

        <div class="btn-nav">
          <h3>Gráficos</h3>
        </div>

        <div class="btn-logout" onclick="limparSessao()">
          <h3>Sair</h3>
        </div>
      </div>

      <div class="dash">
        <h1>Dashboard de Saúde</h1>

        <div class="kpis">
          <div class="kpi-card">
            <h3>Idade Média</h3>
            <p id="idade-media">--</p>
          </div>
          <div class="kpi-card">
            <h3>Atividades Físicas Regulares</h3>
            <p id="atividade-fisica">--%</p>
          </div>
          <div class="kpi-card">
            <h3>Saúde Mental boa</h3>
            <p id="saude-mental">--%</p>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="pizza">
          <div class="chart-container">
            <h2>Atividade Física</h2>
            <canvas id="graficoAtividadeFisica"></canvas>
          </div>

          <div class="chart-container">
            <h2>Qualidade da Alimentação</h2>
            <canvas id="graficoAlimentacao"></canvas>
          </div>
        </div>

        <div class="dispersao">
          <div class="chart-container">
            <h2>Sono x Saúde Mental</h2>
            <canvas id="graficoSonoSaudeMental"></canvas>
          </div>

          <!-- Gráficos de Correlacionamento -->
          <div class="chart-container">
            <h2>Horas de Sono e Nível de Estresse</h2>
            <canvas id="graficoSonoxEstresse"></canvas>
          </div>
        </div>

        <div>
          <h3>Visualização de Objetivos de Saúde</h3>
          <canvas id="graficoObjetivosSaude"></canvas>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  mostrar_cpf.innerHTML = sessionStorage.CPF_USUARIO;


  function obterresponse() {
    
    fetch("/pesquisa/calcularIdadeMedia")
      .then((response) => response.json())
      .then((data) => {
        var numeroInt = Number(data[0].idadeMedia);
        document.getElementById(
          "idade-media"
        ).textContent = `${numeroInt} anos`;
      })
      .catch((error) =>
        console.log("Erro ao carregar response de idade média:", error)
      );


    fetch("/pesquisa/calcularFrequenciaAtividade")
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        var totalPorcentagem = 0;

       
        for (var i = 0; i < data.length; i++) {
          totalPorcentagem += parseFloat(data[i].porcentagem) || 0;
        }

        
        document.getElementById(
          "atividade-fisica"
        ).textContent = `${totalPorcentagem.toFixed(0)}%`;
      })
      .catch(function (error) {
        console.log("Erro ao carregar response de atividade física:", error);
      });

    
    fetch("/pesquisa/calcularSaudeMental")
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        let totalPorcentagem = 0;

        
        for (let i = 0; i < data.length; i++) {
          totalPorcentagem += parseFloat(data[i].porcentagem) || 0;
        }

        
        document.getElementById(
          "saude-mental"
        ).textContent = `${totalPorcentagem.toFixed(0)}%`;
      })
      .catch(function (error) {
        console.log("Erro ao carregar response de saúde mental:", error);
      });

    
    fetch("/pesquisa/atividadeFisica")
      .then(function (response) {
        return response.json();
      })
      .then(function (response) {
        plotarGraficoAtividadeFisica(response);
      })
      .catch(function (err) {
        console.log("Erro ao carregar response de atividade física:", err);
      });

    
    fetch("/pesquisa/alimentacao")
      .then(function (response) {
        return response.json();
      })
      .then(function (response) {
        plotarGraficoAlimentacao(response);
      })
      .catch(function (err) {
        console.log("Erro ao carregar response de alimentação:", err);
      });

    
    fetch("/pesquisa/sonoxEstresse")
      .then(function (response) {
        return response.json();
      })
      .then(function (response) {
        plotarGraficoSonoxEstresse(response);
      })
      .catch(function (err) {
        console.log("Erro ao carregar response de sono x estresse:", err);
      });

    
    fetch("/pesquisa/sonoSaudeMental")
      .then(function (response) {
        return response.json();
      })
      .then(function (response) {
        plotarGraficoSonoSaudeMental(response);
      })
      .catch(function (err) {
        console.log("Erro ao carregar response de sono x saúde mental:", err);
      });

    
    fetch("/pesquisa/objetivoSaude")
      .then(function (response) {
        return response.json();
      })
      .then(function (response) {
        plotarGraficoObjetivosSaude(response);
      })
      .catch(function (err) {
        console.log("Erro ao carregar response de objetivos de saúde:", err);
      });
  }

  function plotarGraficoAtividadeFisica(response) {
    var categorias = [
      "diariamente",
      "semanalmente",
      "ocasionalmente",
      "raramente",
      "nunca",
    ];
    var valores = [0, 0, 0, 0, 0];

    for (var i = 0; i < response.length; i++) {
      var index = categorias.indexOf(response[i].atividade_fisica);
      if (index !== -1) {
        valores[index] += response[i].quantidade;
      }
    }

    var ctx = document
      .getElementById("graficoAtividadeFisica")
      .getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: categorias,
        datasets: [
          {
            data: valores,
            backgroundColor: [
              "#FF6384",
              "#36A2EB",
              "#FFCE56",
              "#4BC0C0",
              "#9966FF",
            ],
          },
        ],
      },
    });
  }

  function plotarGraficoAlimentacao(response) {
    var categorias = ["saudavel", "balanceada", "desregrada", "vegetariana"];
    var valores = [0, 0, 0, 0];

    for (var i = 0; i < response.length; i++) {
      var index = categorias.indexOf(response[i].alimentacao.toLowerCase());
      if (index !== -1) {
        valores[index] += response[i].quantidade;
      }
    }

    var ctx = document.getElementById("graficoAlimentacao").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: categorias,
        datasets: [
          {
            data: valores,
            backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"],
          },
        ],
      },
    });
  }

  function plotarGraficoSonoxEstresse(response) {
    var pontos = [];

    // Mapear os níveis de estresse para valores numéricos
    var nivelEstresseMap = {
      baixo: 1,
      moderado: 2,
      alto: 3,
    };

    for (var i = 0; i < response.length; i++) {
      // Converte o nível de estresse para valor numérico
      var estresseValue =
        nivelEstresseMap[response[i].nivel_estresse.toLowerCase()] || 0;
      pontos.push({ x: response[i].sono, y: estresseValue });
    }

    var ctx = document.getElementById("graficoSonoxEstresse").getContext("2d");
    new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [
          {
            label: "Sono x Estresse",
            data: pontos,
            backgroundColor: "#FF6384",
          },
        ],
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Horas de Sono" } },
          y: {
            title: { display: true, text: "Nível de Estresse"},
            min: -1,
            max: 5,
          },
        },
      },
    });
  }

  function plotarGraficoSonoSaudeMental(response) {
    var pontos = [];

    // Mapear os níveis de saúde mental para valores numéricos
    var saudeMental = {
      excelente: 5,
      regular: 3,
      fraca: 1,
    };

    for (var i = 0; i < response.length; i++) {
      // Converte o nível de saúde mental para valor numérico
      var saudeMentalValue =
        saudeMental[response[i].saude_mental.toLowerCase()] || 0;
      pontos.push({ x: response[i].sono, y: saudeMentalValue });
    }

    var ctx = document
      .getElementById("graficoSonoSaudeMental")
      .getContext("2d");
    new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [
          {
            label: "Sono x Saúde Mental",
            data: pontos,
            backgroundColor: "#36A2EB",
          },
        ],
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Horas de Sono" } },
          y: { title: { display: true, text: "Saúde Mental" }, min: -1, max: 6},
        },
      },
    });
  }

  function plotarGraficoObjetivosSaude(response) {
    var labels = [];
    var valores = [];

    for (var i = 0; i < response.length; i++) {
      labels.push(response[i].objetivos_saude);
      valores.push(response[i].quantidade);
    }

    var ctx = document.getElementById("graficoObjetivosSaude").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          {
            label: "Quantidade",
            data: valores,
            backgroundColor: "#FFCE56",
          },
        ],
      },
      options: {
        scales: {
          y: { beginAtZero: true },
        },
      },
    });
  }
</script>
